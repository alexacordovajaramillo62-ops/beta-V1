-- Brainrot Functions Library v2.0
-- Sistema completo con teleport mejorado, ESP, AutoSteal, y configuración persistente

local BrainrotLib = {}

-- ============================================================
-- SERVICIOS Y MÓDULOS
-- ============================================================

local S = {
    Players = game:GetService("Players"),
    UserInputService = game:GetService("UserInputService"),
    TweenService = game:GetService("TweenService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    HttpService = game:GetService("HttpService"),
    RunService = game:GetService("RunService"),
    Stats = game:GetService("Stats"),
    TeleportService = game:GetService("TeleportService"),
    Lighting = game:GetService("Lighting"),
}

S.Packages = S.ReplicatedStorage:WaitForChild("Packages")
S.Datas = S.ReplicatedStorage:WaitForChild("Datas")
S.Shared = S.ReplicatedStorage:WaitForChild("Shared")
S.Utils = S.ReplicatedStorage:WaitForChild("Utils")

S.Synchronizer = require(S.Packages:WaitForChild("Synchronizer"))
S.AnimalsData = require(S.Datas:WaitForChild("Animals"))
S.RaritiesData = require(S.Datas:WaitForChild("Rarities"))
S.AnimalsShared = require(S.Shared:WaitForChild("Animals"))
S.NumberUtils = require(S.Utils:WaitForChild("NumberUtils"))

S.LocalPlayer = S.Players.LocalPlayer
S.PlayerGui = S.LocalPlayer:WaitForChild("PlayerGui")

-- ============================================================
-- CONFIGURACIÓN GLOBAL Y PERSISTENTE
-- ============================================================

if not getgenv().BRAINROT_CONFIG then
    getgenv().BRAINROT_CONFIG = {
        -- Keybinds
        TELEPORT_KEYBIND = nil,
        TOGGLE_GUI_KEYBIND = nil,
        INSTANT_CLONER_KEYBIND = nil,
        KICK_SELF_KEYBIND = nil,
        FLOOR_STEAL_KEYBIND = nil,
        REJOIN_KEYBIND = nil,
        DESYNC_KEYBIND = nil,

        -- Main Features
        AUTO_TP_ENABLED = false,
        AUTO_HIDE_ENABLED = false,
        AUTO_STEAL_ENABLED = false,
        AUTO_STEAL_NEAREST_ENABLED = false,
        AUTO_STEAL_PRIORITY_ENABLED = false,
        PREDICTIVE_STEAL = false,
        OptimizerEnabled = false,
        FLOOR_STEAL_ENABLED = false,
        AUTO_DESYNC_ENABLED = false,
        STEAL_SPEED_ENABLED = false,
        STEAL_DISABLE_ANIM_ENABLED = false,

        -- Filters
        SHOW_ALL_RARITIES = true,
        SHOW_MUTATIONS_ONLY = false,
        SHOW_TRAITS_ONLY = false,
        MIN_GEN_VALUE = 0,
        
        -- Priority System
        FAVORITES_PRIORITY_ENABLED = false,
        INVISIBLE_BASE_WALLS_ENABLED = false,
        SAFE_TELEPORT = true,
        CARPET_MIDDLE = false,
        
        -- ESP
        ESP_ENABLED = false,
        ESP_PLAYERS_ENABLED = false,
        
        -- Anti-Lag
        ANTI_LAG_ENABLED = false,
        ANTI_BEE_DISCO_ENABLED = false,
        ANTI_RAGDOLL_V1_ENABLED = false,
        ANTI_RAGDOLL_V2_ENABLED = false,
    }
end

local CONFIG = getgenv().BRAINROT_CONFIG

if not getgenv().BRAINROT_FAVORITES then
    getgenv().BRAINROT_FAVORITES = {}
end

local FAVORITES = getgenv().BRAINROT_FAVORITES

local PRIORITY_ANIMALS = {
    "Strawberry Elephant", "Meowl", "Headless Horseman", "Dragon Cannelloni",
    "Capitano Moby", "Cooki and Milki", "La Supreme Combinasion", "Burguro and Fryuro",
    "Garama and Madundung", "Lavadorito Spinito", "Spooky and Pumpky", "La Casa Boo",
    "La Secret Combinasion", "Chillin Chili", "Ketchuru and Musturu", "Ketupat Kepat",
    "La Taco Combinasion", "Tang Tang Keletang", "Tictac Sahur", "W or L",
    "Spaghetti Tualetti", "Nuclearo Dinossauro", "Money Money Puggy"
}

-- ============================================================
-- VARIABLES GLOBALES DEL SISTEMA
-- ============================================================

local allAnimalsCache = {}
local isCloning = false
local highestAnimal = nil
local stats = {
    totalAnimals = 0,
    totalValue = 0,
    highestGen = 0,
    mutationCount = 0,
    traitCount = 0,
}

local ESP_INSTANCES = {}
local PLAYER_ESP = {}
local ESP_BEST_UID = nil

local scannerConnections = {}
local plotChannels = {}
local lastAnimalData = {}

local floatPlatform = nil
local invisibleWallsLoaded = false
local originalTransparency = {}

local InternalStealCache = {}
local AUTO_STEAL_PROX_RADIUS = 20
local PromptMemoryCache = {}
local LastTargetUID = nil
local LastPlayerPosition = nil
local PlayerVelocity = Vector3.zero
local PREDICTION_LOOKAHEAD = 1.25

local STEAL_SPEED = 25.5
local stealSpeedConn = nil
local animDisableConn = nil
local originalAnimIds = {}
local animateScript = nil

local ANIM_TYPES = {"walk", "run", "jump", "fall"}

local PLAYER_OUTLINE_MAIN = Color3.fromRGB(220, 120, 255)
local PLAYER_OUTLINE_SOFT = Color3.new(0.345098, 0.066667, 0.952941)

-- ============================================================
-- SISTEMA DE ARCHIVOS DE CONFIGURACIÓN
-- ============================================================

local ConfigFiles = {
    FAVORITES_FILE = "BrainrotFinderFavorites.json",
    CONFIG_FILE = "BrainrotFinderConfig.json",
    TOGGLE_FILE = "BrainrotToggleStates.json"
}

local function saveToggleStates()
    local toggleStates = {}
    local toggleKeys = {
        "ESP_ENABLED", "ESP_PLAYERS_ENABLED", "AUTO_STEAL_ENABLED",
        "AUTO_STEAL_NEAREST_ENABLED", "AUTO_STEAL_PRIORITY_ENABLED",
        "PREDICTIVE_STEAL", "OptimizerEnabled", "FLOOR_STEAL_ENABLED",
        "AUTO_DESYNC_ENABLED", "STEAL_SPEED_ENABLED", "STEAL_DISABLE_ANIM_ENABLED",
        "INVISIBLE_BASE_WALLS_ENABLED", "ANTI_LAG_ENABLED", "ANTI_BEE_DISCO_ENABLED",
        "ANTI_RAGDOLL_V1_ENABLED", "ANTI_RAGDOLL_V2_ENABLED", "FAVORITES_PRIORITY_ENABLED",
        "AUTO_HIDE_ENABLED", "SAFE_TELEPORT", "AUTO_TP_ENABLED"
    }
    
    for _, key in ipairs(toggleKeys) do
        toggleStates[key] = CONFIG[key]
    end
    
    if writefile then
        local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, toggleStates)
        if success then
            writefile(ConfigFiles.TOGGLE_FILE, jsonData)
        end
    end
end

local function loadToggleStates()
    if not readfile or not isfile(ConfigFiles.TOGGLE_FILE) then return end
    
    local success, jsonData = pcall(readfile, ConfigFiles.TOGGLE_FILE)
    if not success then return end
    
    local success2, savedStates = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if not success2 then return end
    
    for key, value in pairs(savedStates) do
        if CONFIG[key] ~= nil then
            CONFIG[key] = value
            getgenv().BRAINROT_CONFIG[key] = value
        end
    end
end

local function saveFavorites()
    if writefile then
        local success, jsonData = pcall(S.HttpService.JSONEncode, S.HttpService, FAVORITES)
        if success then
            writefile(ConfigFiles.FAVORITES_FILE, jsonData)
        end
    end
end

local function loadFavorites()
    if not readfile or not isfile(ConfigFiles.FAVORITES_FILE) then return end
    
    local success, jsonData = pcall(readfile, ConfigFiles.FAVORITES_FILE)
    if not success then return end
    
    local success2, savedFavorites = pcall(S.HttpService.JSONDecode, S.HttpService, jsonData)
    if success2 and savedFavorites then
        FAVORITES = savedFavorites
        getgenv().BRAINROT_FAVORITES = FAVORITES
    end
end

-- ============================================================
-- FUNCIONES AUXILIARES BÁSICAS
-- ============================================================

local function getHRP()
    local c = S.LocalPlayer.Character
    if not c then return nil end
    return c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("UpperTorso")
end

local function isMyBaseAnimal(animalData)
    if not animalData or not animalData.plot then return false end
    
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return false end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return false end
    
    local channel = S.Synchronizer:Get(plot.Name)
    if channel then
        local owner = channel:Get("Owner")
        if owner then
            if typeof(owner) == "Instance" and owner:IsA("Player") then
                return owner.UserId == S.LocalPlayer.UserId
            elseif typeof(owner) == "table" and owner.UserId then
                return owner.UserId == S.LocalPlayer.UserId
            elseif typeof(owner) == "Instance" then
                return owner == S.LocalPlayer
            end
        end
    end
    
    local sign = plot:FindFirstChild("PlotSign")
    if sign then
        local yourBase = sign:FindFirstChild("YourBase")
        if yourBase and yourBase:IsA("BillboardGui") then
            return yourBase.Enabled == true
        end
    end
    
    return false
end

-- ============================================================
-- SISTEMA DE ESP MEJORADO
-- ============================================================

local function getPodiumWorldPart(animalData)
    if not animalData.plot or not animalData.slot then return nil end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return podium end
    
    local spawn = base:FindFirstChild("Spawn")
    return spawn or base or podium
end

local function clearESPForUID(uid)
    local rec = ESP_INSTANCES[uid]
    if not rec then return end
    if rec.highlight then pcall(function() rec.highlight:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    ESP_INSTANCES[uid] = nil
end

local function clearAllESP()
    for uid in pairs(ESP_INSTANCES) do
        clearESPForUID(uid)
    end
    ESP_BEST_UID = nil
end

local function refreshAllESP()
    if not CONFIG.ESP_ENABLED then
        clearAllESP()
        return
    end
    
    local activeUIDs = {}
    local bestAnimal = nil
    
    for _, animalData in ipairs(allAnimalsCache) do
        if not isMyBaseAnimal(animalData) then
            bestAnimal = animalData
            break
        end
    end
    
    ESP_BEST_UID = bestAnimal and bestAnimal.uid or nil
    
    for _, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData) then continue end
        
        if animalData.uid == ESP_BEST_UID or animalData.genValue >= 50000000 then
            local uid = animalData.uid
            activeUIDs[uid] = true
            
            local rec = ESP_INSTANCES[uid]
            local model = getPodiumWorldPart(animalData)
            
            if not model then
                if rec then clearESPForUID(uid) end
            else
                if not rec or rec.part ~= model then
                    if rec then clearESPForUID(uid) end
                    
                    rec = { part = model }
                    
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = model
                    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                    highlight.FillTransparency = 0.7
                    highlight.FillColor = Color3.fromRGB(220, 120, 255)
                    highlight.OutlineTransparency = 0.5
                    highlight.OutlineColor = Color3.fromRGB(255, 180, 255)
                    highlight.Parent = S.PlayerGui
                    rec.highlight = highlight
                    
                    local bb = Instance.new("BillboardGui")
                    bb.Name = "BrainrotESP"
                    bb.Adornee = model
                    bb.AlwaysOnTop = true
                    bb.Size = UDim2.new(0, 220, 0, 80)
                    bb.StudsOffset = Vector3.new(0, 3.5, 0)
                    bb.Parent = S.PlayerGui
                    
                    local bgFrame = Instance.new("Frame")
                    bgFrame.Size = UDim2.new(1, 0, 1, 0)
                    bgFrame.BackgroundColor3 = Color3.fromRGB(100, 50, 150)
                    bgFrame.BackgroundTransparency = 0.8
                    bgFrame.BorderSizePixel = 0
                    bgFrame.Parent = bb
                    
                    local gradient = Instance.new("UIGradient")
                    gradient.Color = ColorSequence.new({
                        ColorSequenceKeypoint.new(0, Color3.fromRGB(150, 80, 200)),
                        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(100, 180, 255)),
                        ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 200, 150))
                    })
                    gradient.Rotation = 45
                    gradient.Parent = bgFrame
                    
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(0, 10)
                    corner.Parent = bgFrame
                    
                    local stroke = Instance.new("UIStroke")
                    stroke.Color = Color3.fromRGB(255, 255, 255)
                    stroke.Thickness = 2
                    stroke.Transparency = 0.4
                    stroke.Parent = bgFrame
                    
                    task.spawn(function()
                        while bgFrame.Parent do
                            for rot = 45, 405, 2 do
                                if not bgFrame.Parent then break end
                                gradient.Rotation = rot
                                task.wait(0.03)
                            end
                        end
                    end)
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, -10, 0.5, 0)
                    nameLabel.Position = UDim2.new(0, 5, 0, 5)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    nameLabel.TextScaled = true
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    nameLabel.Parent = bgFrame
                    
                    local genLabel = Instance.new("TextLabel")
                    genLabel.Size = UDim2.new(1, -10, 0.5, -5)
                    genLabel.Position = UDim2.new(0, 5, 0.5, 0)
                    genLabel.BackgroundTransparency = 1
                    genLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    genLabel.TextScaled = true
                    genLabel.Font = Enum.Font.GothamBold
                    genLabel.TextStrokeTransparency = 0
                    genLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    genLabel.Parent = bgFrame
                    
                    rec.billboard = bb
                    rec.labelName = nameLabel
                    rec.labelGen = genLabel
                    
                    ESP_INSTANCES[uid] = rec
                end
                
                rec.labelName.Text = animalData.name
                rec.labelGen.Text = animalData.genText
            end
        end
    end
    
    for uid in pairs(ESP_INSTANCES) do
        if not activeUIDs[uid] then
            clearESPForUID(uid)
        end
    end
end

-- ============================================================
-- SISTEMA DE PLAYER ESP
-- ============================================================

local function clearPlayerESP(plr)
    local rec = PLAYER_ESP[plr]
    if not rec then return end
    if rec.highlightMain then pcall(function() rec.highlightMain:Destroy() end) end
    if rec.highlightSoft then pcall(function() rec.highlightSoft:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    PLAYER_ESP[plr] = nil
end

local function clearAllPlayerESP()
    for plr in pairs(PLAYER_ESP) do
        clearPlayerESP(plr)
    end
end

local function createPlayerESP(plr)
    local char = plr.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso") or char.PrimaryPart
    if not hrp then return end
    
    local rec = {}
    
    local hMain = Instance.new("Highlight")
    hMain.Adornee = char
    hMain.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hMain.FillTransparency = 1
    hMain.OutlineTransparency = 0
    hMain.OutlineColor = PLAYER_OUTLINE_MAIN
    hMain.Parent = S.PlayerGui
    rec.highlightMain = hMain
    
    local hSoft = Instance.new("Highlight")
    hSoft.Adornee = char
    hSoft.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hSoft.FillTransparency = 1
    hSoft.OutlineTransparency = 0
    hSoft.OutlineColor = PLAYER_OUTLINE_SOFT
    hSoft.Parent = S.PlayerGui
    rec.highlightSoft = hSoft
    
    local bb = Instance.new("BillboardGui")
    bb.Size = UDim2.new(0, 160, 0, 32)
    bb.Adornee = hrp
    bb.AlwaysOnTop = true
    bb.StudsOffset = Vector3.new(0, 3.2, 0)
    bb.Parent = S.PlayerGui
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(120, 240, 255)
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextStrokeTransparency = 0.3
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Text = plr.Name
    nameLabel.Parent = bb
    
    rec.billboard = bb
    rec.nameLabel = nameLabel
    
    PLAYER_ESP[plr] = rec
end

local function refreshPlayerESP()
    if not CONFIG.ESP_PLAYERS_ENABLED then
        clearAllPlayerESP()
        return
    end
    
    for _, plr in ipairs(S.Players:GetPlayers()) do
        if plr ~= S.LocalPlayer then
            if not PLAYER_ESP[plr] then
                createPlayerESP(plr)
            end
        end
    end
    
    local myChar = S.LocalPlayer.Character
    local myHRP = myChar and (myChar:FindFirstChild("HumanoidRootPart") or myChar:FindFirstChild("UpperTorso") or myChar.PrimaryPart)
    
    for plr, rec in pairs(PLAYER_ESP) do
        local char = plr.Character
        local hrp = char and (char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso") or char.PrimaryPart)
        
        if not char or not hrp or not myHRP then
            clearPlayerESP(plr)
        else
            local dist = (myHRP.Position - hrp.Position).Magnitude
            local distInt = math.floor(dist + 0.5)
            if rec.nameLabel then
                rec.nameLabel.Text = string.format("%s [%dm]", plr.Name, distInt)
            end
        end
    end
end

-- ============================================================
-- SISTEMA DE TELEPORT MEJORADO (SIEMPRE MIRA AL ANIMAL)
-- ============================================================

local function getAnimalPodiumCFrame(animalData)
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    return podium:GetPivot()
end

local function getSideBounds(sideFolder)
    if not sideFolder then return nil end
    
    local minX, minY, minZ = math.huge, math.huge, math.huge
    local maxX, maxY, maxZ = -math.huge, -math.huge, -math.huge
    local found = false
    
    local function scan(obj)
        for _, child in ipairs(obj:GetChildren()) do
            if child:IsA("BasePart") then
                found = true
                local p = child.Position
                minX = math.min(minX, p.X)
                minY = math.min(minY, p.Y)
                minZ = math.min(minZ, p.Z)
                maxX = math.max(maxX, p.X)
                maxY = math.max(maxY, p.Y)
                maxZ = math.max(maxZ, p.Z)
            else
                scan(child)
            end
        end
    end
    
    scan(sideFolder)
    if not found then return nil end
    
    local center = Vector3.new((minX + maxX) * 0.5, (minY + maxY) * 0.5, (minZ + maxZ) * 0.5)
    local halfSize = Vector3.new((maxX - minX) * 0.5, (maxY - minY) * 0.5, (maxZ - minZ) * 0.5)
    
    return {
        center = center,
        halfSize = halfSize,
        minX = minX,
        maxX = maxX,
        minZ = minZ,
        maxZ = maxZ,
    }
end

local function isPositionSafe(position, plot)
    local decorations = plot:FindFirstChild("Decorations")
    if not decorations then return true end
    
    local side3 = decorations:FindFirstChild("Side 3")
    if not side3 then return true end
    
    local info = getSideBounds(side3)
    if not info then return true end
    
    local insideX = position.X >= info.minX and position.X <= info.maxX
    local insideZ = position.Z >= info.minZ and position.Z <= info.maxZ
    
    return not (insideX and insideZ)
end

local function findOptimalViewPosition(podiumCF, plot)
    local podiumPos = podiumCF.Position
    local podiumForward = podiumCF.LookVector
    
    local distanceFromPodium = 15
    local approachPos = podiumPos - (podiumForward * distanceFromPodium)
    local podiumY = podiumPos.Y
    local approachY = math.max(podiumY + 3, 15)
    
    if not isPositionSafe(Vector3.new(approachPos.X, approachY, approachPos.Z), plot) then
        local angles = {0, 45, 90, 135, 180, 225, 270, 315}
        
        for _, angle in ipairs(angles) do
            local rad = math.rad(angle)
            local dir = Vector3.new(math.sin(rad), 0, math.cos(rad))
            local testPos = podiumPos + (dir * distanceFromPodium)
            
            if isPositionSafe(Vector3.new(testPos.X, approachY, testPos.Z), plot) then
                approachPos = testPos
                break
            end
        end
    end
    
    return Vector3.new(approachPos.X, approachY, approachPos.Z), podiumPos
end

local function teleportAndFaceAnimal(animalData)
    local character = S.LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character.HumanoidRootPart
    if not humanoid or not hrp then return false end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return false end
    
    local podiumCF = getAnimalPodiumCFrame(animalData)
    if not podiumCF then return false end
    
    local targetPos, lookAtPos = findOptimalViewPosition(podiumCF, plot)
    
    local usingCarpet = false
    local carpet = S.LocalPlayer.Backpack:FindFirstChild("Flying Carpet")
    
    if carpet then
        humanoid:EquipTool(carpet)
        usingCarpet = true
        task.wait(0.2)
    end
    
    local podiumY = podiumCF.Position.Y
    if podiumY > 20 then
        local state = humanoid:GetState()
        if state ~= Enum.HumanoidStateType.Jumping and state ~= Enum.HumanoidStateType.Freefall then
            humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            task.wait(0.05)
        end
        hrp.Velocity = Vector3.new(hrp.Velocity.X, 250, hrp.Velocity.Z)
        task.wait(0.2)
    end
    
    hrp.CFrame = CFrame.new(targetPos)
    task.wait(0.1)
    
    local lookCFrame = CFrame.new(targetPos, lookAtPos)
    hrp.CFrame = lookCFrame
    
    if usingCarpet then
        print("[Brainrot] Teleport completed while on carpet - Facing animal")
        
        local startTime = tick()
        while tick() - startTime < 1.5 and usingCarpet do
            local currentPos = hrp.Position
            local newLookCFrame = CFrame.new(currentPos, lookAtPos)
            hrp.CFrame = newLookCFrame
            usingCarpet = humanoid:GetState() == Enum.HumanoidStateType.Seated
            task.wait(0.05)
        end
        
        if CONFIG.AUTO_HIDE_ENABLED then
            task.wait(0.5)
            humanoid:UnequipTools()
        end
    end
    
    local finalDist = (hrp.Position - lookAtPos).Magnitude
    print(string.format("[Brainrot] Teleport to %s - Distance: %.1f studs", animalData.name, finalDist))
    
    return true
end

local function teleportToHighestWithView()
    if #allAnimalsCache == 0 then
        print("[Brainrot] No animals found")
        return false
    end
    
    local targetAnimal = nil
    
    if CONFIG.FAVORITES_PRIORITY_ENABLED and #FAVORITES > 0 then
        for _, favName in ipairs(FAVORITES) do
            for _, animal in ipairs(allAnimalsCache) do
                if animal.name:lower() == favName:lower() and not isMyBaseAnimal(animal) then
                    targetAnimal = animal
                    break
                end
            end
            if targetAnimal then break end
        end
    end
    
    if not targetAnimal then
        for _, animal in ipairs(allAnimalsCache) do
            if not isMyBaseAnimal(animal) then
                targetAnimal = animal
                break
            end
        end
    end
    
    if not targetAnimal then
        print("[Brainrot] No target animal found")
        return false
    end
    
    print("[Brainrot] Teleporting to:", targetAnimal.name, "Value:", targetAnimal.genText)
    return teleportAndFaceAnimal(targetAnimal)
end

local function forceLookAtAnimal()
    local hrp = getHRP()
    if not hrp or #allAnimalsCache == 0 then return false end
    
    local targetAnimal = nil
    for _, animal in ipairs(allAnimalsCache) do
        if not isMyBaseAnimal(animal) then
            targetAnimal = animal
            break
        end
    end
    
    if not targetAnimal then return false end
    
    local podiumCF = getAnimalPodiumCFrame(targetAnimal)
    if not podiumCF then return false end
    
    local lookAtPos = podiumCF.Position
    hrp.CFrame = CFrame.new(hrp.Position, lookAtPos)
    
    print("[Brainrot] Now facing:", targetAnimal.name)
    return true
end

-- ============================================================
-- SISTEMA DE AUTO-STEAL MEJORADO
-- ============================================================

local function findProximityPromptForAnimal(animalData)
    if not animalData then return nil end
    
    local cachedPrompt = PromptMemoryCache[animalData.uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    local base = podium:FindFirstChild("Base")
    if not base then return nil end
    
    local spawn = base:FindFirstChild("Spawn")
    if not spawn then return nil end
    
    local attach = spawn:FindFirstChild("PromptAttachment")
    if not attach then return nil end
    
    for _, p in ipairs(attach:GetChildren()) do
        if p:IsA("ProximityPrompt") then
            PromptMemoryCache[animalData.uid] = p
            return p
        end
    end
    
    return nil
end

local function getAnimalPosition(animalData)
    local plot = workspace.Plots:FindFirstChild(animalData.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animalData.slot)
    if not podium then return nil end
    
    return podium:GetPivot().Position
end

local function getNearestAnimal()
    local hrp = getHRP()
    if not hrp then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData) then continue end
        
        local pos = getAnimalPosition(animalData)
        if pos then
            local dist = (hrp.Position - pos).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = animalData
            end
        end
    end
    
    return nearest
end

local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end
    
    local data = {
        holdCallbacks = {},
        triggerCallbacks = {},
        ready = true,
    }
    
    local ok1, conns1 = pcall(getconnections, prompt.PromptButtonHoldBegan)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end
    
    local ok2, conns2 = pcall(getconnections, prompt.Triggered)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end
    
    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

local function runCallbackList(list)
    for _, fn in ipairs(list) do
        task.spawn(fn)
    end
end

local function executeInternalStealAsync(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    
    task.spawn(function()
        if #data.holdCallbacks > 0 then
            runCallbackList(data.holdCallbacks)
        end
        
        task.wait(1.3)
        
        if #data.triggerCallbacks > 0 then
            runCallbackList(data.triggerCallbacks)
        end
        
        task.wait()
        data.ready = true
    end)
    
    return true
end

local function attemptSteal(prompt)
    if not prompt or not prompt.Parent then return false end
    
    buildStealCallbacks(prompt)
    if not InternalStealCache[prompt] then return false end
    
    return executeInternalStealAsync(prompt)
end

local stealConnection = nil

local function autoStealLoop()
    if stealConnection then stealConnection:Disconnect() end
    
    stealConnection = S.RunService.Heartbeat:Connect(function()
        if not CONFIG.AUTO_STEAL_ENABLED and not CONFIG.AUTO_STEAL_NEAREST_ENABLED and not CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            return
        end
        
        local targetAnimal = nil
        
        if CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
            for _, priorityName in ipairs(PRIORITY_ANIMALS) do
                for _, animal in ipairs(allAnimalsCache) do
                    if not isMyBaseAnimal(animal) and animal.name == priorityName then
                        targetAnimal = animal
                        break
                    end
                end
                if targetAnimal then break end
            end
        end
        
        if not targetAnimal and CONFIG.AUTO_STEAL_NEAREST_ENABLED then
            targetAnimal = getNearestAnimal()
        end
        
        if not targetAnimal and CONFIG.AUTO_STEAL_ENABLED then
            for _, animal in ipairs(allAnimalsCache) do
                if not isMyBaseAnimal(animal) then
                    targetAnimal = animal
                    break
                end
            end
        end
        
        if not targetAnimal or isMyBaseAnimal(targetAnimal) then return end
        
        local hrp = getHRP()
        if not hrp then return end
        
        local animalPos = getAnimalPosition(targetAnimal)
        if not animalPos then return end
        
        local dist = (hrp.Position - animalPos).Magnitude
        if dist > AUTO_STEAL_PROX_RADIUS then return end
        
        local prompt = PromptMemoryCache[targetAnimal.uid]
        if not prompt or not prompt.Parent then
            prompt = findProximityPromptForAnimal(targetAnimal)
        end
        
        if prompt then attemptSteal(prompt) end
    end)
end

-- ============================================================
-- SISTEMA DE SCANNER DE ANIMALES
-- ============================================================

local function getAnimalHash(animalList)
    if not animalList then return "" end
    local hash = ""
    for slot, data in pairs(animalList) do
        if type(data) == "table" then
            hash = hash .. tostring(slot) .. tostring(data.Index) .. tostring(data.Mutation)
        end
    end
    return hash
end

local function scanSinglePlot(plot)
    pcall(function()
        local plotUID = plot.Name
        local channel = S.Synchronizer:Get(plotUID)
        if not channel then return end
        
        local animalList = channel:Get("AnimalList")
        local currentHash = getAnimalHash(animalList)
        if lastAnimalData[plotUID] == currentHash then return end
        lastAnimalData[plotUID] = currentHash
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        local owner = channel:Get("Owner")
        if not owner or not S.Players:FindFirstChild(owner.Name) then return end
        
        if not animalList then return end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == "table" then
                local animalName = animalData.Index
                local animalInfo = S.AnimalsData[animalName]
                if not animalInfo then continue end
                
                local rarity = animalInfo.Rarity
                local rarityColor = (S.RaritiesData[rarity] and S.RaritiesData[rarity].Color) or Color3.fromRGB(255, 255, 255)
                
                local mutation = animalData.Mutation or "None"
                local traits = (animalData.Traits and #animalData.Traits > 0) and table.concat(animalData.Traits, ", ") or "None"
                
                local genValue = S.AnimalsShared:GetGeneration(animalName, animalData.Mutation, animalData.Traits, nil)
                local genText = "$" .. S.NumberUtils:ToString(genValue) .. "/s"
                
                table.insert(allAnimalsCache, {
                    name = animalInfo.DisplayName or animalName,
                    genText = genText,
                    genValue = genValue,
                    rarity = rarity,
                    rarityColor = rarityColor,
                    mutation = mutation,
                    traits = traits,
                    owner = owner.Name,
                    plot = plot.Name,
                    slot = tostring(slot),
                    uid = plot.Name .. "_" .. tostring(slot),
                })
            end
        end
        
        stats = {
            totalAnimals = 0,
            totalValue = 0,
            highestGen = 0,
            mutationCount = 0,
            traitCount = 0,
        }
        
        for _, animal in ipairs(allAnimalsCache) do
            stats.totalAnimals = stats.totalAnimals + 1
            stats.totalValue = stats.totalValue + animal.genValue
            stats.highestGen = math.max(stats.highestGen, animal.genValue)
            if animal.mutation ~= "None" then
                stats.mutationCount = stats.mutationCount + 1
            end
            if animal.traits ~= "None" then
                stats.traitCount = stats.traitCount + 1
            end
        end
        
        table.sort(allAnimalsCache, function(a, b)
            return a.genValue > b.genValue
        end)
        
        highestAnimal = allAnimalsCache[1]
        refreshAllESP()
    end)
end

local function initializePlotScanner()
    local plots = workspace:WaitForChild("Plots", 8)
    if not plots then return end
    
    for _, plot in ipairs(plots:GetChildren()) do
        if not plotChannels[plot.Name] then
            plotChannels[plot.Name] = true
            scanSinglePlot(plot)
            
            local c1 = plot.DescendantAdded:Connect(function()
                task.wait(0.1)
                scanSinglePlot(plot)
            end)
            table.insert(scannerConnections, c1)
            
            local c2 = plot.DescendantRemoving:Connect(function()
                task.wait(0.1)
                scanSinglePlot(plot)
            end)
            table.insert(scannerConnections, c2)
            
            local c3 = task.spawn(function()
                while plot.Parent and plotChannels[plot.Name] do
                    task.wait(5)
                    scanSinglePlot(plot)
                end
            end)
            table.insert(scannerConnections, c3)
        end
    end
    
    local newPlotConnection = plots.ChildAdded:Connect(function(plot)
        task.wait(0.5)
        if not plotChannels[plot.Name] then
            plotChannels[plot.Name] = true
            scanSinglePlot(plot)
        end
    end)
    table.insert(scannerConnections, newPlotConnection)
    
    local removedPlotConnection = plots.ChildRemoved:Connect(function(plot)
        plotChannels[plot.Name] = nil
        lastAnimalData[plot.Name] = nil
        
        for i = #allAnimalsCache, 1, -1 do
            if allAnimalsCache[i].plot == plot.Name then
                table.remove(allAnimalsCache, i)
            end
        end
        
        refreshAllESP()
    end)
    table.insert(scannerConnections, removedPlotConnection)
end

local function setupPromptCacheCleanup()
    local plots = workspace:WaitForChild("Plots", 8)
    if not plots then return end
    
    plots.ChildRemoved:Connect(function(plot)
        for uid, prompt in pairs(PromptMemoryCache) do
            if uid:find(plot.Name) then
                PromptMemoryCache[uid] = nil
            end
        end
    end)
end

-- ============================================================
-- FUNCIONES DE LA BIBLIOTECA BRAINROT (INTERFAZ PÚBLICA)
-- ============================================================

function BrainrotLib:Init()
    loadToggleStates()
    loadFavorites()
    
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    
    initializePlotScanner()
    autoStealLoop()
    setupPromptCacheCleanup()
    
    S.RunService.Heartbeat:Connect(function()
        refreshPlayerESP()
    end)
    
    S.UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == CONFIG.TELEPORT_KEYBIND then
            self:TeleportToHighest()
        elseif input.KeyCode == CONFIG.INSTANT_CLONER_KEYBIND then
            self:InstantCloner()
        elseif input.KeyCode == CONFIG.FLOOR_STEAL_KEYBIND then
            self:ToggleFloorSteal()
        elseif input.KeyCode == CONFIG.DESYNC_KEYBIND then
            self:EnableDesync()
        end
    end)
    
    print("[Brainrot] Initialized successfully")
    return true
end

-- ESP Functions
function BrainrotLib:ToggleESP()
    CONFIG.ESP_ENABLED = not CONFIG.ESP_ENABLED
    saveToggleStates()
    
    if CONFIG.ESP_ENABLED then
        refreshAllESP()
        print("[Brainrot] ESP activated")
    else
        clearAllESP()
        print("[Brainrot] ESP deactivated")
    end
    return CONFIG.ESP_ENABLED
end

function BrainrotLib:TogglePlayerESP()
    CONFIG.ESP_PLAYERS_ENABLED = not CONFIG.ESP_PLAYERS_ENABLED
    saveToggleStates()
    
    if CONFIG.ESP_PLAYERS_ENABLED then
        refreshPlayerESP()
        print("[Brainrot] Player ESP activated")
    else
        clearAllPlayerESP()
        print("[Brainrot] Player ESP deactivated")
    end
    return CONFIG.ESP_PLAYERS_ENABLED
end

-- AutoSteal Functions
function BrainrotLib:ToggleAutoSteal()
    CONFIG.AUTO_STEAL_ENABLED = not CONFIG.AUTO_STEAL_ENABLED
    saveToggleStates()
    
    if CONFIG.AUTO_STEAL_ENABLED then
        autoStealLoop()
        print("[Brainrot] AutoSteal activated")
    else
        if stealConnection then
            stealConnection:Disconnect()
            stealConnection = nil
        end
        print("[Brainrot] AutoSteal deactivated")
    end
    return CONFIG.AUTO_STEAL_ENABLED
end

function BrainrotLib:ToggleAutoStealNearest()
    CONFIG.AUTO_STEAL_NEAREST_ENABLED = not CONFIG.AUTO_STEAL_NEAREST_ENABLED
    saveToggleStates()
    
    if CONFIG.AUTO_STEAL_NEAREST_ENABLED then
        autoStealLoop()
        print("[Brainrot] AutoSteal Nearest activated")
    else
        if stealConnection then
            stealConnection:Disconnect()
            stealConnection = nil
        end
        print("[Brainrot] AutoSteal Nearest deactivated")
    end
    return CONFIG.AUTO_STEAL_NEAREST_ENABLED
end

function BrainrotLib:ToggleAutoStealPriority()
    CONFIG.AUTO_STEAL_PRIORITY_ENABLED = not CONFIG.AUTO_STEAL_PRIORITY_ENABLED
    saveToggleStates()
    
    if CONFIG.AUTO_STEAL_PRIORITY_ENABLED then
        autoStealLoop()
        print("[Brainrot] AutoSteal Priority activated")
    else
        if stealConnection then
            stealConnection:Disconnect()
            stealConnection = nil
        end
        print("[Brainrot] AutoSteal Priority deactivated")
    end
    return CONFIG.AUTO_STEAL_PRIORITY_ENABLED
end

function BrainrotLib:TogglePredictiveSteal()
    CONFIG.PREDICTIVE_STEAL = not CONFIG.PREDICTIVE_STEAL
    saveToggleStates()
    print("[Brainrot] Predictive Steal:", CONFIG.PREDICTIVE_STEAL and "activated" or "deactivated")
    return CONFIG.PREDICTIVE_STEAL
end

-- Teleport Functions (IMPROVED)
function BrainrotLib:TeleportToHighest()
    return teleportToHighestWithView()
end

function BrainrotLib:LookAtHighestAnimal()
    return forceLookAtAnimal()
end

function BrainrotLib:CarpetTeleportToHighest()
    local character = S.LocalPlayer.Character
    if not character then return false end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return false end
    
    local carpet = S.LocalPlayer.Backpack:FindFirstChild("Flying Carpet")
    if not carpet then
        print("[Brainrot] No carpet found")
        return teleportToHighestWithView()
    end
    
    humanoid:EquipTool(carpet)
    task.wait(0.3)
    return teleportToHighestWithView()
end

-- Utility Functions
function BrainrotLib:InstantCloner()
    if isCloning then return false end
    isCloning = true
    
    local success, err = pcall(function()
        local character = S.LocalPlayer.Character
        if not character then error("Character not found") end
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid then error("Humanoid not found") end
        
        for _, tool in ipairs(character:GetChildren()) do
            if tool:IsA("Tool") then
                humanoid:UnequipTools()
                task.wait(0.1)
                break
            end
        end
        
        local backpack = S.LocalPlayer.Backpack
        local cloner = backpack:FindFirstChild("Quantum Cloner")
        if not cloner then error("Quantum Cloner not found") end
        
        humanoid:EquipTool(cloner)
        task.wait()
        
        local useRemote = S.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")
        useRemote:FireServer()
        task.wait()
        
        local clonerRemote = S.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/QuantumCloner/OnTeleport")
        clonerRemote:FireServer()
    end)
    
    if not success then
        warn("[Brainrot] Cloner failed:", err)
    end
    
    task.wait(1)
    isCloning = false
    return success
end

function BrainrotLib:KickSelf()
    S.LocalPlayer:Kick("Kicked by Brainrot")
    return true
end

function BrainrotLib:RejoinServer()
    local placeId = game.PlaceId
    local jobId = game.JobId
    
    task.delay(0.15, function()
        local ok, err = pcall(function()
            if jobId and jobId ~= "" then
                S.TeleportService:TeleportToPlaceInstance(placeId, jobId, S.LocalPlayer)
            else
                S.TeleportService:Teleport(placeId, S.LocalPlayer)
            end
        end)
        
        if not ok then
            warn("[Brainrot] Rejoin failed:", err)
        end
    end)
    return true
end

function BrainrotLib:EnableDesync()
    local DESYNC_FLAGS = {
        LargeReplicatorEnabled9 = true,
        GameNetDontSendRedundantNumTimes = 1,
        MaxTimestepMultiplierAcceleration = 2147483647,
        InterpolationFrameVelocityThresholdMillionth = 5,
        CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
        TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
        GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
        TimestepArbiterHumanoidTurningVelThreshold = 1,
        LargeReplicatorSerializeWrite4 = true,
        SimExplicitlyCappedTimestepMultiplier = 2147483646,
        InterpolationFrameRotVelocityThresholdMillionth = 5,
        ServerMaxBandwith = 52,
        LargeReplicatorSerializeRead3 = true,
        GameNetDontSendRedundantDeltaPositionMillionth = 1,
        PhysicsSenderMaxBandwidthBps = 20000,
        CheckPVCachedVelThresholdPercent = 10,
        NextGenReplicatorEnabledWrite4 = true,
        LargeReplicatorWrite5 = true,
        MaxMissedWorldStepsRemembered = -2147483648,
        StreamJobNOUVolumeCap = 2147483647,
        CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
        DisableDPIScale = true,
        WorldStepMax = 30,
        InterpolationFramePositionThresholdMillionth = 5,
        MaxAcceptableUpdateDelay = 1,
        TimestepArbiterOmegaThou = 1073741823,
        CheckPVCachedRotVelThresholdPercent = 10,
        StreamJobNOUVolumeLengthCap = 2147483647,
        S2PhysicsSenderRate = 15000,
        MaxTimestepMultiplierBuoyancy = 2147483647,
        SimOwnedNOUCountThresholdMillionth = 2147483647,
        ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
        LargeReplicatorRead5 = true,
        CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
        MaxDataPacketPerSend = 2147483647,
        MaxTimestepMultiplierContstraint = 2147483647,
        DebugSendDistInSteps = -2147483648,
        GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
        AngularVelociryLimit = 360
    }
    
    for key, value in pairs(DESYNC_FLAGS) do
        pcall(function()
            setfflag(tostring(key), tostring(value))
        end)
    end
    
    print("[Brainrot] Desync activated")
    return true
end

function BrainrotLib:ToggleAutoDesync()
    CONFIG.AUTO_DESYNC_ENABLED = not CONFIG.AUTO_DESYNC_ENABLED
    saveToggleStates()
    
    if CONFIG.AUTO_DESYNC_ENABLED then
        self:EnableDesync()
        print("[Brainrot] Auto Desync activated")
    else
        print("[Brainrot] Auto Desync deactivated")
    end
    return CONFIG.AUTO_DESYNC_ENABLED
end

-- Floor Steal Functions
function BrainrotLib:ToggleFloorSteal()
    CONFIG.FLOOR_STEAL_ENABLED = not CONFIG.FLOOR_STEAL_ENABLED
    saveToggleStates()
    
    if CONFIG.FLOOR_STEAL_ENABLED then
        if floatPlatform then floatPlatform:Destroy() end
        
        floatPlatform = Instance.new("Part")
        floatPlatform.Size = Vector3.new(6, 1, 6)
        floatPlatform.Anchored = true
        floatPlatform.CanCollide = true
        floatPlatform.Transparency = 1
        floatPlatform.Parent = workspace
        
        task.spawn(function()
            while CONFIG.FLOOR_STEAL_ENABLED and floatPlatform do
                local hrp = getHRP()
                if hrp then
                    floatPlatform.Position = hrp.Position - Vector3.new(0, 3, 0)
                end
                task.wait(0.05)
            end
        end)
        
        print("[Brainrot] Floor Steal activated")
    else
        if floatPlatform then
            floatPlatform:Destroy()
            floatPlatform = nil
        end
        print("[Brainrot] Floor Steal deactivated")
    end
    return CONFIG.FLOOR_STEAL_ENABLED
end

-- Speed Functions
function BrainrotLib:ToggleStealSpeed()
    CONFIG.STEAL_SPEED_ENABLED = not CONFIG.STEAL_SPEED_ENABLED
    saveToggleStates()
    
    if CONFIG.STEAL_SPEED_ENABLED then
        if stealSpeedConn then stealSpeedConn:Disconnect() end
        
        stealSpeedConn = S.RunService.Heartbeat:Connect(function()
            if not CONFIG.STEAL_SPEED_ENABLED then return end
            if not S.LocalPlayer:GetAttribute("Stealing") then return end
            
            local char = S.LocalPlayer.Character
            if not char then return end
            local hum = char:FindFirstChildOfClass("Humanoid")
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hum or not hrp then return end
            
            local move = hum.MoveDirection
            if move.Magnitude > 0 then
                hrp.AssemblyLinearVelocity = Vector3.new(
                    move.X * STEAL_SPEED,
                    hrp.AssemblyLinearVelocity.Y,
                    move.Z * STEAL_SPEED
                )
            end
        end)
        
        print("[Brainrot] Steal Speed activated")
    else
        if stealSpeedConn then
            stealSpeedConn:Disconnect()
            stealSpeedConn = nil
        end
        print("[Brainrot] Steal Speed deactivated")
    end
    return CONFIG.STEAL_SPEED_ENABLED
end

-- Config Management
function BrainrotLib:GetConfig(key)
    return CONFIG[key]
end

function BrainrotLib:SetConfig(key, value)
    CONFIG[key] = value
    getgenv().BRAINROT_CONFIG[key] = value
    saveToggleStates()
    return true
end

function BrainrotLib:SaveAllConfig()
    saveToggleStates()
    saveFavorites()
    print("[Brainrot] All configurations saved")
    return true
end

function BrainrotLib:LoadAllConfig()
    loadToggleStates()
    loadFavorites()
    print("[Brainrot] Configurations loaded")
    return true
end

function BrainrotLib:ResetAllToggles()
    local toggleKeys = {
        "ESP_ENABLED", "ESP_PLAYERS_ENABLED", "AUTO_STEAL_ENABLED",
        "AUTO_STEAL_NEAREST_ENABLED", "AUTO_STEAL_PRIORITY_ENABLED",
        "PREDICTIVE_STEAL", "OptimizerEnabled", "FLOOR_STEAL_ENABLED",
        "AUTO_DESYNC_ENABLED", "STEAL_SPEED_ENABLED", "STEAL_DISABLE_ANIM_ENABLED",
        "INVISIBLE_BASE_WALLS_ENABLED", "ANTI_LAG_ENABLED", "ANTI_BEE_DISCO_ENABLED",
        "ANTI_RAGDOLL_V1_ENABLED", "ANTI_RAGDOLL_V2_ENABLED", "FAVORITES_PRIORITY_ENABLED",
        "AUTO_HIDE_ENABLED", "SAFE_TELEPORT", "AUTO_TP_ENABLED"
    }
    
    for _, key in ipairs(toggleKeys) do
        CONFIG[key] = false
        getgenv().BRAINROT_CONFIG[key] = false
    end
    
    saveToggleStates()
    print("[Brainrot] All toggles reset")
    return true
end

-- Status Functions
function BrainrotLib:GetStatus()
    return {
        ESP = CONFIG.ESP_ENABLED,
        PlayerESP = CONFIG.ESP_PLAYERS_ENABLED,
        AutoSteal = CONFIG.AUTO_STEAL_ENABLED,
        AutoStealNearest = CONFIG.AUTO_STEAL_NEAREST_ENABLED,
        AutoStealPriority = CONFIG.AUTO_STEAL_PRIORITY_ENABLED,
        PredictiveSteal = CONFIG.PREDICTIVE_STEAL,
        FloorSteal = CONFIG.FLOOR_STEAL_ENABLED,
        AutoDesync = CONFIG.AUTO_DESYNC_ENABLED,
        StealSpeed = CONFIG.STEAL_SPEED_ENABLED,
        FavoritesPriority = CONFIG.FAVORITES_PRIORITY_ENABLED,
        AutoHideCarpet = CONFIG.AUTO_HIDE_ENABLED,
        SafeTeleport = CONFIG.SAFE_TELEPORT,
        AutoTP = CONFIG.AUTO_TP_ENABLED,
        AnimalCount = #allAnimalsCache,
        TotalValue = stats.totalValue,
        HighestValue = highestAnimal and highestAnimal.genText or "None"
    }
end

function BrainrotLib:PrintStatus()
    local status = self:GetStatus()
    print("=== BRAINROT STATUS ===")
    for key, value in pairs(status) do
        if type(value) == "boolean" then
            print(string.format("%s: %s", key, value and "✅ ON" or "❌ OFF"))
        else
            print(string.format("%s: %s", key, tostring(value)))
        end
    end
    print("========================")
end

-- Favorites Management
function BrainrotLib:AddFavorite(name)
    for _, fav in ipairs(FAVORITES) do
        if fav:lower() == name:lower() then
            return false
        end
    end
    
    table.insert(FAVORITES, name)
    saveFavorites()
    print("[Brainrot] Added favorite:", name)
    return true
end

function BrainrotLib:RemoveFavorite(name)
    for i, fav in ipairs(FAVORITES) do
        if fav:lower() == name:lower() then
            table.remove(FAVORITES, i)
            saveFavorites()
            print("[Brainrot] Removed favorite:", name)
            return true
        end
    end
    return false
end

function BrainrotLib:GetFavorites()
    return FAVORITES
end

function BrainrotLib:ClearFavorites()
    FAVORITES = {}
    getgenv().BRAINROT_FAVORITES = FAVORITES
    saveFavorites()
    print("[Brainrot] Cleared all favorites")
    return true
end

-- Scanner Functions
function BrainrotLib:RescanPlots()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return false end
    
    for _, plot in ipairs(plots:GetChildren()) do
        scanSinglePlot(plot)
    end
    
    print("[Brainrot] Rescanned all plots")
    return true
end

function BrainrotLib:GetAnimalCount()
    return #allAnimalsCache
end

function BrainrotLib:GetHighestAnimal()
    return highestAnimal
end

function BrainrotLib:GetAnimalList()
    return allAnimalsCache
end

return BrainrotLib
